<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BelInvest | Plataforma de Investimento</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBuOzmtFPWeNKJTKB-jrLxFmfn2Nswypvc",
      authDomain: "invest-8c4e6.firebaseapp.com",
      projectId: "invest-8c4e6",
      storageBucket: "invest-8c4e6.appspot.com",
      messagingSenderId: "1021993177452",
      appId: "1:1021993177452:web:f704ca9b8127bb3ba76349"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    const porcentagemRendimentoDiario = 1; // 1% ao dia

    // ------------------------ Cadastro ------------------------
    async function cadastrarUsuario(nome, email, senha, cpf, telefone, uidIndicante = null) {
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
        const user = userCredential.user;

        await setDoc(doc(db, "usuarios", user.uid), {
          nome,
          email,
          cpf,
          telefone,
          saldo: 0,
          primeiroDeposito: false,
          linkWhatsAppLiberado: false,
          linkIndicadoPor: uidIndicante
        });

        alert("Cadastro realizado com sucesso!");
      } catch (error) {
        alert("Erro no cadastro: " + error.message);
      }
    }

    // ------------------------ Login ------------------------
    async function loginUsuario(email, senha) {
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, senha);
        currentUser = userCredential.user;
        await carregarPainel(currentUser.uid);
      } catch (error) {
        alert("Erro no login: " + error.message);
      }
    }

    // ------------------------ Depósito ------------------------
    async function registrarDeposito(uid, valor, codigoCupom = null) {
      let bonus = 0;

      if (codigoCupom) {
        const cupomRef = doc(db, "cupons", codigoCupom);
        const cupomSnap = await getDoc(cupomRef);
        if (cupomSnap.exists() && !cupomSnap.data().usado) {
          bonus = cupomSnap.data().valor;
          await updateDoc(cupomRef, { usado: true });
        }
      }

      const usuarioRef = doc(db, "usuarios", uid);
      const usuarioSnap = await getDoc(usuarioRef);
      let saldoAtual = usuarioSnap.data().saldo || 0;

      // Atualizar saldo com valor do depósito
      saldoAtual += valor + bonus;

      // Primeiro depósito libera WhatsApp
      await updateDoc(usuarioRef, {
        saldo: saldoAtual,
        primeiroDeposito: true,
        linkWhatsAppLiberado: true
      });

      await addDoc(collection(db, "depositos"), {
        usuarioId: uid,
        valor: valor,
        data: new Date(),
        status: "concluido",
        cupomUsado: codigoCupom
      });

      // Aplicar comissão para indicante
      if (usuarioSnap.data().linkIndicadoPor) {
        const porcentagemComissao = 5; // 5% de comissão
        await aplicarComissao(usuarioSnap.data().linkIndicadoPor, valor, porcentagemComissao, uid);
      }

      alert("Depósito realizado com sucesso!");
      await carregarPainel(uid);
    }

    // ------------------------ Comissão de indicação ------------------------
    async function aplicarComissao(uidIndicante, valorDeposito, porcentagem, uidIndicado) {
      const comissao = (valorDeposito * porcentagem) / 100;
      const indicanteRef = doc(db, "usuarios", uidIndicante);
      const indicanteSnap = await getDoc(indicanteRef);
      const saldoAtual = indicanteSnap.data().saldo || 0;

      await updateDoc(indicanteRef, { saldo: saldoAtual + comissao });

      await addDoc(collection(db, "indicacoes"), {
        indicanteId: uidIndicante,
        indicadoId: uidIndicado,
        valorDeposito,
        comissao
      });
    }

    // ------------------------ Link de indicação ------------------------
    function gerarLinkIndicacao(uid) {
      return `${window.location.origin}?indicadoPor=${uid}`;
    }

    // ------------------------ Rendimento diário ------------------------
    async function atualizarRendimento(uid) {
      const usuarioRef = doc(db, "usuarios", uid);
      const usuarioSnap = await getDoc(usuarioRef);

      const depositosQuery = query(collection(db, "depositos"), where("usuarioId", "==", uid));
      const depositosSnap = await getDocs(depositosQuery);

      let saldoAtual = 0;

      for (let depDoc of depositosSnap.docs) {
        const dep = depDoc.data();
        const valor = dep.valor;
        const dataDeposito = dep.data.toDate();
        const hoje = new Date();
        const diffDias = Math.floor((hoje - dataDeposito) / (1000 * 60 * 60 * 24));

        const rendimento = valor * Math.pow(1 + porcentagemRendimentoDiario / 100, diffDias) - valor;
        saldoAtual += valor + rendimento;
      }

      await updateDoc(usuarioRef, { saldo: saldoAtual });
      document.getElementById("saldoUsuario").innerText = "R$ " + saldoAtual.toFixed(2);
    }

    // ------------------------ Painel do usuário ------------------------
    async function carregarPainel(uid) {
      const usuarioRef = doc(db, "usuarios", uid);
      const usuarioSnap = await getDoc(usuarioRef);
      const usuario = usuarioSnap.data();

      document.getElementById("painel").style.display = "block";
      document.getElementById("loginCadastro").style.display = "none";
      document.getElementById("nomeUsuario").innerText = usuario.nome;

      // Atualizar saldo com rendimento
      await atualizarRendimento(uid);

      // Link de indicação
      document.getElementById("linkIndicacao").innerText = gerarLinkIndicacao(uid);
      document.getElementById("linkIndicacao").href = gerarLinkIndicacao(uid);

      // Indicados e depósitos
      const indicadosQuery = query(collection(db, "usuarios"), where("linkIndicadoPor", "==", uid));
      const indicadosSnap = await getDocs(indicadosQuery);
      const lista = document.getElementById("listaIndicados");
      lista.innerHTML = "";

      for (let docSnap of indicadosSnap.docs) {
        const indicado = docSnap.data();
        let totalDeposito = 0;

        const depositosQuery = query(collection(db, "depositos"), where("usuarioId", "==", docSnap.id));
        const depositosSnap = await getDocs(depositosQuery);
        depositosSnap.forEach(dep => { totalDeposito += dep.data().valor; });

        lista.innerHTML += `<li>${indicado.nome} - Depósito: R$ ${totalDeposito.toFixed(2)}</li>`;
      }

      // WhatsApp VIP
      if (usuario.linkWhatsAppLiberado) {
        document.getElementById("linkWhatsApp").style.display = "block";
      }
    }

    // ------------------------ Funções de UI ------------------------
    window.cadastrar = async () => {
      const nome = document.getElementById("nome").value;
      const email = document.getElementById("email").value;
      const senha = document.getElementById("senha").value;
      const cpf = document.getElementById("cpf").value;
      const telefone = document.getElementById("telefone").value;

      const params = new URLSearchParams(window.location.search);
      const uidIndicante = params.get("indicadoPor");

      await cadastrarUsuario(nome, email, senha, cpf, telefone, uidIndicante);
    }

    window.logar = async () => {
      const email = document.getElementById("loginEmail").value;
      const senha = document.getElementById("loginSenha").value;
      await loginUsuario(email, senha);
    }

    window.depositar = async () => {
      const valor = parseFloat(document.getElementById("valorDeposito").value);
      const cupom = document.getElementById("cupomDeposito").value || null;
      if (!currentUser) { alert("Faça login primeiro!"); return; }
      await registrarDeposito(currentUser.uid, valor, cupom);
    }

  </script>
</head>
<body class="bg-gray-100 p-4">

  <!-- Login / Cadastro -->
  <div id="loginCadastro" class="max-w-md mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">Cadastro</h2>
    <input id="nome" placeholder="Nome" class="border p-2 w-full mb-2">
    <input id="email" placeholder="Email" class="border p-2 w-full mb-2">
    <input id="senha" placeholder="Senha" type="password" class="border p-2 w-full mb-2">
    <input id="cpf" placeholder="CPF" class="border p-2 w-full mb-2">
    <input id="telefone" placeholder="Telefone" class="border p-2 w-full mb-2">
    <button onclick="cadastrar()" class="bg-blue-500 text-white p-2 w-full mb-4">Cadastrar</button>

    <h2 class="text-xl font-bold mb-4">Login</h2>
    <input id="loginEmail" placeholder="Email" class="border p-2 w-full mb-2">
    <input id="loginSenha" placeholder="Senha" type="password" class="border p-2 w-full mb-2">
    <button onclick="logar()" class="bg-green-500 text-white p-2 w-full">Login</button>
  </div>

  <!-- Painel do Usuário -->
  <div id="painel" style="display:none;" class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">Olá, <span id="nomeUsuario"></span></h2>
    <p class="mb-2">Saldo: <span id="saldoUsuario"></span></p>

    <h3 class="text-lg font-bold mt-4 mb-2">Depósito</h3>
    <input id="valorDeposito" placeholder="Valor" type="number" class="border p-2 w-full mb-2">
    <input id="cupomDeposito" placeholder="Cupom (opcional)" class="border p-2 w-full mb-2">
    <button onclick="depositar()" class="bg-blue-500 text-white p-2 w-full mb-4">Depositar</button>

    <h3 class="text-lg font-bold mt-4 mb-2">Seu link de indicação</h3>
    <a id="linkIndicacao" href="#" class="text-blue-700 underline mb-4 block"></a>

    <h3 class="text-lg font-bold mt-4 mb-2">Seus indicados</h3>
    <ul id="listaIndicados" class="list-disc ml-6"></ul>

    <a id="linkWhatsApp" href="https://chat.whatsapp.com/SEU_LINK_AQUI" target="_blank" class="bg-green-500 text-white p-2 w-full block mt-4 text-center rounded" style="display:none;">Acessar grupo VIP WhatsApp</a>
  </div>

</body>
</html>
