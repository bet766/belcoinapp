<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat Firebase</title>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background:#ece5dd; margin:0 }
.container { max-width:400px; margin:auto; padding:15px }

.tabs { display:flex }
.tab {
  flex:1;
  padding:10px;
  background:#ccc;
  text-align:center;
  cursor:pointer;
}
.tab.active { background:#25d366; color:#fff }

input, button { width:100%; padding:10px; margin:5px 0 }
button { background:#25d366; color:#fff; border:none; cursor:pointer }

.section { display:none }
.section.active { display:block }

.chat-box { background:#fff; height:300px; overflow-y:auto; padding:10px }
.msg { margin:5px 0; max-width:80% }
.me { text-align:right; margin-left:auto; background:#dcf8c6; padding:5px; border-radius:5px }
.other { text-align:left; background:#f1f0f0; padding:5px; border-radius:5px }
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="container">

  <div class="tabs">
    <div class="tab active" onclick="showTab('login')">Login</div>
    <div class="tab" onclick="showTab('register')">Cadastro</div>
  </div>

  <!-- LOGIN -->
  <div id="loginTab" class="section active">
    <h2>Entrar</h2>
    <input id="emailLogin" placeholder="Email">
    <input id="passwordLogin" type="password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
  </div>

  <!-- CADASTRO -->
  <div id="registerTab" class="section">
    <h2>Criar conta</h2>
    <input id="name" placeholder="Nome">
    <input id="emailInput" placeholder="Email">
    <input id="password" type="password" placeholder="Senha">
    <button onclick="register()">Cadastrar</button>
  </div>

</div>

<!-- CHAT -->
<div id="chat" class="container" style="display:none">
  <h3 id="myCode"></h3>

  <input id="contactCode" placeholder="C√≥digo do contato">
  <button onclick="openChat()">Abrir conversa</button>

  <div class="chat-box" id="messages"></div>

  <input id="msgInput" placeholder="Mensagem">
  <button onclick="sendMsg()">Enviar</button>
</div>

<script>
// üî• FIREBASE (TEU PROJETO)
const firebaseConfig = {
  apiKey: "AIzaSyCb3qXhVccF5zaM1kT7Y0qSgpyJlltTWSE",
  authDomain: "chat-a1210.firebaseapp.com",
  projectId: "chat-a1210",
  storageBucket: "chat-a1210.appspot.com",
  messagingSenderId: "158588715768",
  appId: "1:158588715768:web:15d8dd4f109250954cb10d"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentChatId = null;

// üîÅ CONTROLE DAS ABAS
function showTab(tab) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));

  if (tab === "login") {
    document.querySelectorAll(".tab")[0].classList.add("active");
    loginTab.classList.add("active");
  } else {
    document.querySelectorAll(".tab")[1].classList.add("active");
    registerTab.classList.add("active");
  }
}

// üîë C√ìDIGO √öNICO
function gerarCodigo() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

// üìù CADASTRO
function register() {
  const nome = name.value;
  const email = emailInput.value;
  const senha = password.value;

  if (!nome || !email || !senha) {
    alert("Preencha todos os campos");
    return;
  }

  auth.createUserWithEmailAndPassword(email, senha)
    .then(res => {
      const uid = res.user.uid;
      const codigo = gerarCodigo();

      db.collection("users").doc(uid).set({
        name: nome,
        email: email,
        code: codigo,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("Cadastro criado! Fa√ßa login.");
      showTab("login");
    })
    .catch(err => alert(err.message));
}

// üîì LOGIN
function login() {
  auth.signInWithEmailAndPassword(emailLogin.value, passwordLogin.value)
    .then(() => iniciar())
    .catch(err => alert(err.message));
}

// üöÄ INICIAR CHAT
function iniciar() {
  authDiv = document.getElementById("auth");
  authDiv.style.display = "none";
  chat.style.display = "block";

  db.collection("users").doc(auth.currentUser.uid).get()
    .then(doc => {
      myCode.innerHTML = "Seu c√≥digo: <b>" + doc.data().code + "</b>";
    });
}

// üí¨ ABRIR CHAT
async function openChat() {
  const code = contactCode.value.trim();
  if (!code) return;

  const snap = await db.collection("users")
    .where("code", "==", code).get();

  if (snap.empty) {
    alert("Usu√°rio n√£o encontrado");
    return;
  }

  const otherUid = snap.docs[0].id;
  const myUid = auth.currentUser.uid;

  currentChatId = [myUid, otherUid].sort().join("_");

  db.collection("chats").doc(currentChatId).set({
    members: {
      [myUid]: true,
      [otherUid]: true
    }
  }, { merge:true });

  ouvirMensagens();
}

// üëÇ MENSAGENS
function ouvirMensagens() {
  messages.innerHTML = "";

  db.collection("chats").doc(currentChatId)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snap => {
      messages.innerHTML = "";
      snap.forEach(doc => {
        const m = doc.data();
        const div = document.createElement("div");
        div.className = "msg " + (m.sender === auth.currentUser.uid ? "me" : "other");
        div.innerText = m.text;
        messages.appendChild(div);
      });
      messages.scrollTop = messages.scrollHeight;
    });
}

// ‚úâÔ∏è ENVIAR
function sendMsg() {
  if (!currentChatId || !msgInput.value) return;

  db.collection("chats").doc(currentChatId)
    .collection("messages").add({
      sender: auth.currentUser.uid,
      text: msgInput.value,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });

  msgInput.value = "";
}
</script>

</body>
</html>
