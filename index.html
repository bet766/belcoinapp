from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes
from tinydb import TinyDB, Query
from datetime import datetime

# Banco de dados
db = TinyDB("db.json")
users = db.table("users")
investments = db.table("investments")

# /start - Cadastro
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if not users.search(Query().id == user_id):
        users.insert({"id": user_id, "name": update.effective_user.first_name, "saldo": 0})
        await update.message.reply_text(f"Bem-vindo {update.effective_user.first_name}! Sua conta foi criada.")
    else:
        await update.message.reply_text("Você já possui uma conta.")

# /investir <valor>
async def investir(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if len(context.args) != 1:
        await update.message.reply_text("Use /investir <valor>, ex: /investir 5")
        return
    valor = float(context.args[0])
    investments.insert({
        "user_id": user_id,
        "valor": valor,
        "inicio": datetime.now().isoformat()
    })
    await update.message.reply_text(f"Investimento de R${valor:.2f} realizado!")

# /saldo
async def saldo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user = users.get(Query().id == user_id)
    total = user["saldo"]
    for inv in investments.search(Query().user_id == user_id):
        inicio = datetime.fromisoformat(inv["inicio"])
        horas = (datetime.now() - inicio).total_seconds() / 3600
        rendimento = inv["valor"] * 0.01 * horas
        total += rendimento
    await update.message.reply_text(f"Seu saldo atual é: R${total:.2f}")

# /sacar <valor>
async def sacar(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if len(context.args) != 1:
        await update.message.reply_text("Use /sacar <valor>, ex: /sacar 1.50")
        return
    valor = float(context.args[0])
    user = users.get(Query().id == user_id)
    total = user["saldo"]
    for inv in investments.search(Query().user_id == user_id):
        inicio = datetime.fromisoformat(inv["inicio"])
        horas = (datetime.now() - inicio).total_seconds() / 3600
        rendimento = inv["valor"] * 0.01 * horas
        total += rendimento
    if valor > total:
        await update.message.reply_text("Saldo insuficiente.")
    else:
        users.update({"saldo": total - valor}, Query().id == user_id)
        await update.message.reply_text(f"Saque de R${valor:.2f} realizado!")

# Configuração do bot
app = ApplicationBuilder().token("7370719597:AAHNU1L6fpCg91_FxJ4UyRWYfkfKEduM_Ac").build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CommandHandler("investir", investir))
app.add_handler(CommandHandler("saldo", saldo))
app.add_handler(CommandHandler("sacar", sacar))

app.run_polling()
